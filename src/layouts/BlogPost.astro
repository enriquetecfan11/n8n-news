---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { getCollection } from 'astro:content';
import { NewsFilter } from '../utils/newsFilter';
import { SITE_TITLE } from '../consts';

type Props = CollectionEntry<"blog">["data"] & {
  id: string;
};

const { title, description, pubDate, updatedDate, impact, sectors, source, sentiment, relevanceScore, tickers, id } = Astro.props;

// Obtener noticias relacionadas
const allPosts = await getCollection('blog');
const newsFilter = new NewsFilter(allPosts);
const relatedPosts = newsFilter.getRelatedPosts(id, 5);

// Funciones de utilidad para metadatos
function getImpactColor(impact: string) {
  switch (impact) {
    case 'alto': return '#dc3545';
    case 'medio': return '#ffc107';
    case 'bajo': return '#28a745';
    default: return '#6c757d';
  }
}

function getSentimentColor(sentiment: string) {
  switch (sentiment) {
    case 'positivo': return '#28a745';
    case 'negativo': return '#dc3545';
    case 'neutral': return '#6c757d';
    default: return '#6c757d';
  }
}

function getSentimentIcon(sentiment: string) {
  switch (sentiment) {
    case 'positivo': return 'üìà';
    case 'negativo': return 'üìâ';
    case 'neutral': return '‚û°Ô∏è';
    default: return 'üìä';
  }
}

function getSectorIcon(sector: string) {
  const icons: Record<string, string> = {
    'tecnolog√≠a': 'üíª',
    'finanzas': 'üí∞',
    'energ√≠a': '‚ö°',
    'salud': 'üè•',
    'consumo': 'üõí',
    'pol√≠tica': 'üèõÔ∏è',
    'econom√≠a': 'üìä',
    'automotriz': 'üöó',
    'comercio': 'üåç'
  };
  return icons[sector] || 'üìã';
}
---

<html lang="es">
  <head>
    <BaseHead title={`${title} - ${SITE_TITLE}`} description={description} />
    <style>
      body {
        background-color: #f5f7fa;
        margin: 0;
        font-family: "Inter", system-ui, sans-serif;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .post-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .main-content {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .post-header {
        background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
        color: white;
        padding: 2rem;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .metadata-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .impact-badge {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .sentiment-badge {
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
      }

      .relevance-score {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .score-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
      }

      .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
        transition: width 0.3s ease;
      }

      .sectors-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .sector-tag {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        border: 1px solid rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        font-weight: 500;
      }

      .tickers-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .ticker-badge {
        background: rgba(255, 255, 255, 0.15);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.25);
        cursor: pointer;
        transition: all 0.2s;
        backdrop-filter: blur(10px);
      }

      .ticker-badge:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
      }

      .post-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0 0 1rem 0;
        line-height: 1.2;
        color: #ffffff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        letter-spacing: -0.02em;
      }

      .post-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
        opacity: 0.95;
        color: #e2e8f0;
        font-weight: 500;
      }

      .post-content {
        padding: 2rem;
        line-height: 1.85;
        font-size: 1.05rem;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .sidebar-widget {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .widget-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .related-post {
        padding: 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
        display: block;
      }

      .related-post:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        transform: translateY(-1px);
      }

      .related-post h4 {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: #333;
        line-height: 1.3;
      }

      .related-post-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #6c757d;
      }

      .share-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e9ecef;
      }

      .share-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: white;
        color: #6c757d;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .share-btn:hover {
        border-color: #007bff;
        color: #007bff;
        background: #f8f9fa;
      }

      @media (max-width: 768px) {
        .post-layout {
          grid-template-columns: 1fr;
          gap: 1rem;
          padding: 1rem;
        }

        .post-header {
          padding: 1.5rem;
        }

        .post-title {
          font-size: 2rem;
        }

        .post-content {
          padding: 1.5rem;
        }

        .sidebar-widget {
          padding: 1rem;
        }
      }
    </style>
  </head>

  <body>
    <Header />
    <main>
      <div class="post-layout">
        <article class="main-content">
          <div class="post-header">
            <!-- Metadatos financieros -->
            <div class="metadata-badges">
              {impact && (
                <span class="badge impact-badge" style={`background-color: ${getImpactColor(impact)};`}>
                  {impact.toUpperCase()}
                </span>
              )}
              {sentiment && (
                <span class="badge sentiment-badge" style={`background-color: ${getSentimentColor(sentiment)};`}>
                  {getSentimentIcon(sentiment)} {sentiment}
                </span>
              )}
            </div>

            <!-- Score de relevancia -->
            {relevanceScore && (
              <div class="relevance-score">
                <span>Relevancia:</span>
                <div class="score-bar">
                  <div class="score-fill" style={`width: ${(relevanceScore / 10) * 100}%;`}></div>
                </div>
                <span>{relevanceScore}/10</span>
              </div>
            )}

            <!-- Sectores -->
            {sectors && sectors.length > 0 && (
              <div class="sectors-container">
                {sectors.map(sector => (
                  <span class="sector-tag">
                    {getSectorIcon(sector)} {sector}
                  </span>
                ))}
              </div>
            )}

            <!-- Tickers -->
            {tickers && tickers.length > 0 && (
              <div class="tickers-container">
                {tickers.map(ticker => (
                  <span class="ticker-badge" onclick={`window.open('https://www.tradingview.com/symbols/${ticker}/', '_blank')`}>
                    {ticker}
                  </span>
                ))}
              </div>
            )}

            <!-- T√≠tulo -->
            <h1 class="post-title">{title}</h1>

            <!-- Meta informaci√≥n -->
            <div class="post-meta">
              <span>üìÖ <FormattedDate date={pubDate} /></span>
              {source && <span>üì∞ {source}</span>}
              {updatedDate && (
                <span>üîÑ Actualizado: <FormattedDate date={updatedDate} /></span>
              )}
            </div>
          </div>

          <div class="post-content">
            <slot />
          </div>

          <!-- Botones de compartir -->
          <div class="share-buttons">
            <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`} 
               class="share-btn" target="_blank" rel="noopener">
              üê¶ Twitter
            </a>
            <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`} 
               class="share-btn" target="_blank" rel="noopener">
              üíº LinkedIn
            </a>
            <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} 
               class="share-btn" target="_blank" rel="noopener">
              üìò Facebook
            </a>
            <button class="share-btn" onclick="copyToClipboard()">
              üìã Copiar enlace
            </button>
          </div>
        </article>

        <aside class="sidebar">
          <!-- Noticias relacionadas -->
          {relatedPosts.length > 0 && (
            <div class="sidebar-widget">
              <h3 class="widget-title">
                üîó Noticias Relacionadas
              </h3>
              {relatedPosts.map(post => (
                <a href={`/blog/${post.id}/`} class="related-post">
                  <h4>{post.data.title}</h4>
                  <div class="related-post-meta">
                    <span>üìÖ <FormattedDate date={post.data.pubDate} /></span>
                    {post.data.impact && <span>‚Ä¢ {post.data.impact}</span>}
                    {post.data.sentiment && <span>‚Ä¢ {getSentimentIcon(post.data.sentiment)}</span>}
                  </div>
                </a>
              ))}
            </div>
          )}

          <!-- Widget de an√°lisis -->
          <div class="sidebar-widget">
            <h3 class="widget-title">
              üìä An√°lisis del Art√≠culo
            </h3>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              {impact && (
                <div>
                  <strong>Impacto:</strong> 
                  <span style={`color: ${getImpactColor(impact)}; font-weight: 600;`}>
                    {impact.toUpperCase()}
                  </span>
                </div>
              )}
              {sentiment && (
                <div>
                  <strong>Sentimiento:</strong> 
                  <span style={`color: ${getSentimentColor(sentiment)}; font-weight: 600;`}>
                    {getSentimentIcon(sentiment)} {sentiment}
                  </span>
                </div>
              )}
              {relevanceScore && (
                <div>
                  <strong>Relevancia:</strong> 
                  <span style="font-weight: 600;">{relevanceScore}/10</span>
                </div>
              )}
              {sectors && sectors.length > 0 && (
                <div>
                  <strong>Sectores:</strong> 
                  <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">
                    {sectors.map(sector => (
                      <span style="background: #e9ecef; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                        {getSectorIcon(sector)} {sector}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          <!-- Widget de navegaci√≥n -->
          <div class="sidebar-widget">
            <h3 class="widget-title">
              üß≠ Navegaci√≥n
            </h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <a href="/blog/" style="color: #007bff; text-decoration: none; padding: 0.5rem; border-radius: 8px; background: #f8f9fa; transition: background 0.2s;">
                üì∞ Todas las noticias
              </a>
              {sectors && sectors.length > 0 && (
                <a href={`/blog/sector/${sectors[0]}/`} style="color: #007bff; text-decoration: none; padding: 0.5rem; border-radius: 8px; background: #f8f9fa; transition: background 0.2s;">
                  üè∑Ô∏è M√°s de {sectors[0]}
                </a>
              )}
              {tickers && tickers.length > 0 && (
                <a href={`/blog/ticker/${tickers[0]}/`} style="color: #007bff; text-decoration: none; padding: 0.5rem; border-radius: 8px; background: #f8f9fa; transition: background 0.2s;">
                  üìà Noticias de {tickers[0]}
                </a>
              )}
            </div>
          </div>
        </aside>
      </div>
    </main>
    <Footer />

    <script>
      function copyToClipboard() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          // Crear notificaci√≥n temporal
          const notification = document.createElement('div');
          notification.textContent = 'Enlace copiado al portapapeles';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 0.9rem;
            font-weight: 600;
          `;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.remove();
          }, 3000);
        });
      }

      // A√±adir hover effects a los enlaces de navegaci√≥n
      document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.sidebar-widget a');
        navLinks.forEach(link => {
          link.addEventListener('mouseenter', function(this: HTMLElement) {
            this.style.background = '#e3f2fd';
          });
          link.addEventListener('mouseleave', function(this: HTMLElement) {
            this.style.background = '#f8f9fa';
          });
        });
      });
    </script>
  </body>
</html>

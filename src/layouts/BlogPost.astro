---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { getCollection } from 'astro:content';
import { NewsFilter } from '../utils/newsFilter';
import { SITE_TITLE } from '../consts';

type Props = CollectionEntry<"blog">["data"] & {
  id: string;
};

const { title, description, pubDate, updatedDate, impact, sectors, source, sentiment, relevanceScore, tickers, id } = Astro.props;

// Obtener noticias relacionadas
const allPosts = await getCollection('blog');
const newsFilter = new NewsFilter(allPosts);
const relatedPosts = newsFilter.getRelatedPosts(id, 5);

// Funciones de utilidad para metadatos
function getImpactColor(impact: string) {
  switch (impact) {
    case 'alto': return 'var(--impact-alto)';
    case 'medio': return 'var(--impact-medio)';
    case 'bajo': return 'var(--impact-bajo)';
    default: return 'var(--text-lighter)';
  }
}

function getSentimentColor(sentiment: string) {
  switch (sentiment) {
    case 'positivo': return 'var(--sentiment-positivo)';
    case 'negativo': return 'var(--sentiment-negativo)';
    case 'neutral': return 'var(--sentiment-neutral)';
    default: return 'var(--sentiment-neutral)';
  }
}

function getSentimentIcon(sentiment: string) {
  switch (sentiment) {
    case 'positivo': return 'üìà';
    case 'negativo': return 'üìâ';
    case 'neutral': return '‚û°Ô∏è';
    default: return 'üìä';
  }
}

function getSectorIcon(sector: string) {
  const icons: Record<string, string> = {
    'tecnolog√≠a': 'üíª',
    'finanzas': 'üí∞',
    'energ√≠a': '‚ö°',
    'salud': 'üè•',
    'consumo': 'üõí',
    'pol√≠tica': 'üèõÔ∏è',
    'econom√≠a': 'üìä',
    'automotriz': 'üöó',
    'comercio': 'üåç'
  };
  return icons[sector] || 'üìã';
}

function getRelevanceAccent(score?: number) {
  if (!score && score !== 0) return '#2196F3';
  return score >= 7 ? '#2196F3' : '#FF9800';
}

function getSectorChipStyle(sector: string) {
  const s = sector.toLowerCase();
  if (s.includes('retail') || s.includes('consumo')) {
    return ' --chip-bg-custom:#E3F2FD; --chip-fg-custom:#1565C0; --chip-border-custom:rgba(21,101,192,.22) ';
  }
  if (s.includes('manufact') || s.includes('fabrica') || s.includes('industr')) {
    return ' --chip-bg-custom:#E8F5E9; --chip-fg-custom:#2E7D32; --chip-border-custom:rgba(46,125,50,.22) ';
  }
  if (s.includes('tech') || s.includes('tecnolog')) {
    return ' --chip-bg-custom:#F3E5F5; --chip-fg-custom:#6A1B9A; --chip-border-custom:rgba(106,27,154,.22) ';
  }
  return '';
}
---

<html lang="es">
  <head>
    <BaseHead title={`${title} - ${SITE_TITLE}`} description={description} />
    <style>
      /* Usar tokens globales de news-variables/design-tokens */
      :root {
        --bg: var(--background);
        --page: var(--bg-secondary, var(--background-alt));
        --text: var(--text);
        --muted: var(--text-secondary, #6b7280);
        --border: var(--border-color);
        --primary: var(--text, #1f2937);
        --chip-bg: var(--bg-tertiary, #f3f4f6);
        --chip-fg: var(--text, #374151);
        --accent: var(--accent, #0D47A1);
      }

      body {
        background-color: var(--page);
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        color: var(--text);
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .post-layout {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 2rem;
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      .main-content {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
      }

      .post-header {
        padding: 1.5rem 1.25rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .badges-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text);
        background: var(--bg-tertiary, var(--chip-bg));
        border: 1px solid var(--border);
      }
      .impact-badge { border-color: ${getImpactColor(impact)}; color: ${getImpactColor(impact)}; }
      .sentiment-badge { border-color: ${getSentimentColor(sentiment)}; color: ${getSentimentColor(sentiment)}; }

      .score-inline {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        background: var(--bg-tertiary, var(--chip-bg));
        color: var(--text, var(--chip-fg));
        font-size: 0.75rem;
        font-weight: 600;
      }

      .chips-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        background: var(--chip-bg-custom, var(--bg-tertiary, var(--chip-bg)));
        color: var(--chip-fg-custom, var(--text, var(--chip-fg)));
        border: 1px solid var(--chip-border-custom, transparent);
        font-size: 0.8rem;
        font-weight: 500;
      }

      .post-title {
        margin: 0.25rem 0 0;
        font-size: 1.8rem;
        line-height: 1.25;
        letter-spacing: -0.01em;
        color: #263238; /* gris carb√≥n para menor fatiga visual */
      }

      .post-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        color: #616161; /* gris con contraste suficiente */
        font-size: 0.9rem;
      }

      .post-content {
        padding: 1.25rem;
      }

      .post-content :global(h2) {
        margin-top: 1.75rem;
        margin-bottom: 0.75rem;
        font-size: 1.35rem;
      }

      .post-content :global(p) {
        line-height: 1.7;
      }

      .share-buttons {
        display: flex;
        gap: 0.5rem;
        padding: 1.25rem;
        border-top: 1px solid var(--border);
      }

      .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 0.9rem;
        border: 1px solid var(--border);
        background: var(--bg);
        color: var(--text);
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.85rem;
        text-decoration: none;
      }

      .share-twitter { border-color: #1DA1F2; color: #1DA1F2; }
      .share-linkedin { border-color: #0A66C2; color: #0A66C2; }
      .share-facebook { border-color: #1877F2; color: #1877F2; }
      .share-copy { border-color: #757575; color: #757575; }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .sidebar-card {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem;
      }

      .sidebar-title {
        margin: 0 0 0.75rem;
        font-size: 0.95rem;
        color: var(--muted);
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-weight: 700;
      }

      .related-item {
        display: block;
        padding: 0.6rem 0.5rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--primary);
        border: 1px solid transparent;
      }

      .related-item:hover { border-color: var(--border); }

      .related-meta {
        display: flex;
        gap: 0.5rem;
        color: var(--muted);
        font-size: 0.8rem;
      }

      @media (max-width: 980px) {
        .post-layout {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <Header />
    <main>
      <div class="post-layout">
        <article class="main-content">
          <div class="post-header">
            <div class="badges-row">
              {impact && (
                <span class="badge impact-badge">{impact.toUpperCase()}</span>
              )}
              {sentiment && (
                <span class="badge sentiment-badge">{getSentimentIcon(sentiment)} {sentiment}</span>
              )}
              {relevanceScore && (
                <span class="score-inline">Relevancia {relevanceScore}/10</span>
              )}
            </div>

            {sectors && sectors.length > 0 && (
              <div class="chips-row">
                {sectors.map(sector => (
                  <span class="chip" style={getSectorChipStyle(sector)}>{getSectorIcon(sector)} {sector}</span>
                ))}
              </div>
            )}

            {tickers && tickers.length > 0 && (
              <div class="chips-row">
                {tickers.map(ticker => (
                  <a class="chip" href={`/blog/ticker/${ticker}/`}>üìà {ticker}</a>
                ))}
              </div>
            )}

            <h1 class="post-title">{title}</h1>
            <div class="post-meta">
              <span>üìÖ <FormattedDate date={pubDate} /></span>
              {source && <span>üì∞ {source}</span>}
              {updatedDate && (
                <span>üîÑ Actualizado: <FormattedDate date={updatedDate} /></span>
              )}
            </div>
          </div>

          <div class="post-content">
            <slot />
          </div>

          <div class="share-buttons">
            <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`} class="share-btn share-twitter" target="_blank" rel="noopener">üê¶ Compartir</a>
            <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`} class="share-btn share-linkedin" target="_blank" rel="noopener">üíº LinkedIn</a>
            <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} class="share-btn share-facebook" target="_blank" rel="noopener">üìò Facebook</a>
            <button class="share-btn share-copy" onclick="copyToClipboard()">üìã Copiar</button>
          </div>
        </article>

        <aside class="sidebar">
          {relatedPosts.length > 0 && (
            <div class="sidebar-card">
              <h3 class="sidebar-title">Noticias relacionadas</h3>
              {relatedPosts.map(post => (
                <a href={`/blog/${post.id}/`} class="related-item">
                  <div>{post.data.title}</div>
                  <div class="related-meta">
                    <span><FormattedDate date={post.data.pubDate} /></span>
                    {post.data.impact && <span>‚Ä¢ {post.data.impact}</span>}
                    {post.data.sentiment && <span>‚Ä¢ {getSentimentIcon(post.data.sentiment)}</span>}
                  </div>
                </a>
              ))}
            </div>
          )}

          <div class="sidebar-card">
            <h3 class="sidebar-title">Navegaci√≥n</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <a class="related-item" href="/blog/">Todas las noticias</a>
              {sectors && sectors.length > 0 && (
                <a class="related-item" href={`/blog/sector/${sectors[0]}/`}>M√°s de {sectors[0]}</a>
              )}
              {tickers && tickers.length > 0 && (
                <a class="related-item" href={`/blog/ticker/${tickers[0]}/`}>Noticias de {tickers[0]}</a>
              )}
            </div>
          </div>
        </aside>
      </div>
    </main>
    <Footer />

    <script>
      function copyToClipboard() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          const notification = document.createElement('div');
          notification.textContent = 'Enlace copiado al portapapeles';
          notification.style.cssText = `
            position: fixed; top: 20px; right: 20px;
            background: #E0E0E0; color: #111827;
            padding: 0.75rem 1rem; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000; font-size: 0.85rem; font-weight: 600;`;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 2400);
        });
      }
    </script>
  </body>
</html>

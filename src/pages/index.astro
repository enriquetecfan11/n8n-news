---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import StockTicker from "../components/finance/StockTicker.astro";
import ProfessionalNewsList from "../components/news/ProfessionalNewsList.astro";
import QuickAnalysisSidebar from "../components/finance/QuickAnalysisSidebar.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import { getCollection, type CollectionEntry } from "astro:content";

// Obtener las noticias ordenadas por fecha (las m치s recientes primero)
const posts = (await getCollection("blog")).sort((a, b) => {
	// Get dates without time
	const dateA = new Date(
		a.data.pubDate.getFullYear(),
		a.data.pubDate.getMonth(),
		a.data.pubDate.getDate(),
	);
	const dateB = new Date(
		b.data.pubDate.getFullYear(),
		b.data.pubDate.getMonth(),
		b.data.pubDate.getDate(),
	);

	// Compare dates first (newest day first)
	const dateCompare = dateB.getTime() - dateA.getTime();
	if (dateCompare !== 0) return dateCompare;

	// If same date, sort by complete timestamp (newest first)
	return b.data.pubDate.getTime() - a.data.pubDate.getTime();
});

// Agrupar noticias por fecha
const groupedPosts = posts.reduce((groups: Record<string, CollectionEntry<"blog">[]>, post) => {
	const date = post.data.pubDate.toLocaleDateString("es-ES", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});

	if (!groups[date]) {
		groups[date] = [];
	}

	groups[date].push(post);
	return groups;
}, {} as Record<string, CollectionEntry<"blog">[]>);
---

<!doctype html>
<html lang="es">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<!-- Importar las variables CSS globales -->
		<link rel="stylesheet" href="../styles/news-variables.css" />
	</head>
	<body>
		<Header />

		<!-- Ticker financiero minimalista -->
		<section class="ticker-section">
			<div class="wrapper ticker-container">
				<StockTicker
					speed={80}
					refreshInterval={60000}
					darkMode={false}
					data-refresh-interval={60000}
				/>
			</div>
		</section>

		<!-- Layout principal con 2 columnas -->
		<main class="main-content">
			<div class="wrapper">
				<div class="dashboard-layout">
					<!-- Columna 1: Noticias principales -->
					<section class="news-column">
						<ProfessionalNewsList groupedPosts={groupedPosts} />
					</section>

					<!-- Columna 2: An치lisis r치pido -->
					<aside class="analysis-column">
						<QuickAnalysisSidebar />
					</aside>
				</div>
			</div>
		</main>

		<Footer />
	</body>
</html>

<style>
	/* Ticker financiero */
	.ticker-section {
		padding: 1.5rem 0;
		background: #f8fafc;
		border-bottom: 1px solid #e5e7eb;
	}

	.ticker-container {
		max-width: 1400px;
	}


	/* Layout principal */
	.main-content {
		padding: 2rem 0;
		background: #ffffff;
		min-height: 60vh;
	}

	.wrapper {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 2rem;
	}

	/* Dashboard de 2 columnas */
	.dashboard-layout {
		display: grid;
		grid-template-columns: 1fr 320px;
		gap: 2rem;
		align-items: start;
	}

	/* Columna de noticias */
	.news-column {
		min-width: 0; /* Permite que el contenido se ajuste */
	}

	/* Columna de an치lisis */
	.analysis-column {
		position: sticky;
		top: 100px;
		height: fit-content;
	}

	/* Responsive */
	@media (max-width: 1200px) {
		.dashboard-layout {
			grid-template-columns: 1fr 300px;
			gap: 1.5rem;
		}
	}

	@media (max-width: 1024px) {
		.dashboard-layout {
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		.analysis-column {
			position: static;
		}

		.wrapper {
			padding: 0 1.5rem;
		}
	}

	@media (max-width: 768px) {
		.main-content {
			padding: 1.5rem 0;
		}

		.wrapper {
			padding: 0 1rem;
		}

		.dashboard-layout {
			gap: 1.5rem;
		}
	}

	@media (max-width: 480px) {
		.wrapper {
			padding: 0 0.75rem;
		}

		.dashboard-layout {
			gap: 1rem;
		}
	}
</style>

---
// Componente para mostrar una tarjeta de noticia individual

interface Props {
    title: string;
    url: string;
    isHighlight?: boolean;
    category?: string;
    pubDate?: Date;
    imageUrl?: string;
    excerpt?: string;
    priority?: boolean;
    newsId?: string;
    impact?: 'alto' | 'medio' | 'bajo';
    sectors?: string[];
    source?: string;
    sentiment?: 'positivo' | 'neutral' | 'negativo';
    relevanceScore?: number;
    tickers?: string[];
}

const { 
    title, 
    url, 
    isHighlight = false, 
    category, 
    pubDate, 
    imageUrl, 
    excerpt, 
    priority = false,
    newsId,
    impact = 'medio',
    sectors = [],
    source = 'Fuente desconocida',
    sentiment = 'neutral',
    relevanceScore = 5,
    tickers = []
} = Astro.props;

// Funci√≥n para obtener el icono seg√∫n el sector
function getSectorIcon(sector: string): string {
    const sectorLower = sector.toLowerCase();
    if (sectorLower.includes("tecnolog") || sectorLower.includes("tech")) return "üíª";
    if (sectorLower.includes("finanz") || sectorLower.includes("banc")) return "üí∞";
    if (sectorLower.includes("energ") || sectorLower.includes("petrol")) return "‚ö°";
    if (sectorLower.includes("salud") || sectorLower.includes("medic")) return "üè•";
    if (sectorLower.includes("consumo") || sectorLower.includes("retail")) return "üõí";
    if (sectorLower.includes("politic") || sectorLower.includes("gobierno")) return "üèõÔ∏è";
    if (sectorLower.includes("econom") || sectorLower.includes("macro")) return "üíπ";
    if (sectorLower.includes("automotriz") || sectorLower.includes("auto")) return "üöó";
    if (sectorLower.includes("comercio") || sectorLower.includes("trade")) return "üì¶";
    return "üìä";
}

// Funci√≥n para obtener el color seg√∫n el nivel de impacto
function getImpactColor(impact: string): string {
    switch (impact) {
        case 'alto': return '#ef4444'; // Rojo
        case 'medio': return '#f59e0b'; // Amarillo
        case 'bajo': return '#10b981'; // Verde
        default: return '#6b7280'; // Gris
    }
}

// Funci√≥n para obtener el color seg√∫n el sentimiento
function getSentimentColor(sentiment: string): string {
    switch (sentiment) {
        case 'positivo': return '#2E7D32'; // Verde
        case 'negativo': return '#C62828'; // Rojo
        case 'neutral': return '#1565C0'; // Azul suave
        default: return '#1565C0';
    }
}

// Funci√≥n para obtener el fondo seg√∫n el sentimiento
function getSentimentBackground(sentiment: string): string {
    switch (sentiment) {
        case 'positivo': return 'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)';
        case 'negativo': return 'linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%)';
        case 'neutral': return 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)';
        default: return 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)';
    }
}

// Funci√≥n para obtener el color de borde seg√∫n el sentimiento
function getSentimentBorder(sentiment: string): string {
    switch (sentiment) {
        case 'positivo': return '#43A047';
        case 'negativo': return '#E53935';
        case 'neutral': return '#1976D2';
        default: return '#1976D2';
    }
}

// Funci√≥n para obtener el color de relevancia
function getRelevanceColor(score: number): string {
    if (score <= 3) return '#F44336'; // Rojo
    if (score <= 6) return '#FF9800'; // Naranja
    if (score <= 8) return '#1976D2'; // Azul
    return '#4CAF50'; // Verde
}

// Funci√≥n para obtener la clase CSS del sector
function getSectorClass(sector: string): string {
    const sectorLower = sector.toLowerCase();
    if (sectorLower.includes("retail") || sectorLower.includes("consumo")) return "retail";
    if (sectorLower.includes("manufactur") || sectorLower.includes("industri")) return "manufacturing";
    if (sectorLower.includes("tecnolog") || sectorLower.includes("tech")) return "technology";
    if (sectorLower.includes("finanz") || sectorLower.includes("banc")) return "finance";
    if (sectorLower.includes("energ") || sectorLower.includes("petrol")) return "energy";
    if (sectorLower.includes("salud") || sectorLower.includes("medic")) return "healthcare";
    return "default";
}

// Funci√≥n para obtener el icono seg√∫n el sentimiento
function getSentimentIcon(sentiment: string): string {
    switch (sentiment) {
        case 'positivo': return 'üìà';
        case 'negativo': return 'üìâ';
        case 'neutral': return '‚û°Ô∏è';
        default: return '‚û°Ô∏è';
    }
}

// Funci√≥n para obtener el color de borde seg√∫n el sector principal
function getSectorBorderColor(sectors: string[]): string {
    if (sectors.length === 0) return "var(--accent-blue)";
    
    const primarySector = sectors[0].toLowerCase();
    if (primarySector.includes("tecnolog")) return "#6366f1"; // Indigo
    if (primarySector.includes("finanz")) return "#10b981"; // Verde
    if (primarySector.includes("energ")) return "#f59e0b"; // Amarillo
    if (primarySector.includes("salud")) return "#ec4899"; // Rosa
    if (primarySector.includes("consumo")) return "#8b5cf6"; // P√∫rpura
    if (primarySector.includes("politic")) return "#3b82f6"; // Azul
    if (primarySector.includes("econom")) return "#f59e0b"; // Amarillo
    if (primarySector.includes("automotriz")) return "#ef4444"; // Rojo
    if (primarySector.includes("comercio")) return "#06b6d4"; // Cian
    
    return "var(--accent-blue)";
}

// Formatear tiempo relativo
function getRelativeTime(date?: Date): string {
    if (!date) return "";

    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / (1000 * 60));

    if (diffMins < 60) {
        return `Hace ${diffMins} ${diffMins === 1 ? "minuto" : "minutos"}`;
    }

    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) {
        return `Hace ${diffHours} ${diffHours === 1 ? "hora" : "horas"}`;
    }

    const diffDays = Math.floor(diffHours / 24);
    return `Hace ${diffDays} ${diffDays === 1 ? "d√≠a" : "d√≠as"}`;
}

const timeAgo = getRelativeTime(pubDate);
const sectorBorderColor = getSectorBorderColor(sectors);
const impactColor = getImpactColor(impact);
const sentimentColor = getSentimentColor(sentiment);
const sentimentBackground = getSentimentBackground(sentiment);
const sentimentBorder = getSentimentBorder(sentiment);
const sentimentIcon = getSentimentIcon(sentiment);
---

<article
    class={`news-card ${isHighlight ? "highlight" : ""} impact-${impact}`}
    style={`--sector-color: ${sectorBorderColor}; --impact-color: ${impactColor}; --sentiment-color: ${sentimentColor};`}
    role="article"
    aria-labelledby={`news-title-${title.replace(/\s+/g, '-').toLowerCase()}`}
>
    <a href={url} class="card-link" aria-describedby={`news-excerpt-${title.replace(/\s+/g, '-').toLowerCase()}`}>
        {/* 1. PRIMERO: T√çTULO PRINCIPAL - Lo m√°s prominente */}
        <div class="news-title-section">
            <h2 class="news-title" id={`news-title-${title.replace(/\s+/g, '-').toLowerCase()}`}>
                {title}
            </h2>
        </div>

        {/* 2. SEGUNDO: Separador visual */}
        <hr class="title-separator">

        {/* 3. TERCERO: Metadata organizada y compacta */}
        <div class="metadata-section">
            {/* Fila 1: Badges de sentimiento y relevancia */}
            <div class="metadata-row">
                <div class="badges-container">
                    <span class="impact-badge" style={`background-color: ${impactColor};`}>
                        {impact.toUpperCase()}
                    </span>
                    <span class="sentiment-badge" style={`background: ${sentimentBackground}; color: ${sentimentColor}; border-left: 3px solid ${sentimentBorder};`}>
                        {sentimentIcon} {sentiment}
                    </span>
                </div>
                <div class="relevance-score">
                    <span class="score-label" style={`color: ${getRelevanceColor(relevanceScore)};`}>Relevancia: {relevanceScore}/10</span>
                </div>
            </div>

            {/* Fila 2: Sectores impactados */}
            {sectors.length > 0 && (
                <div class="metadata-row">
                    <span class="label-small">SECTORES IMPACTADOS</span>
                    <div class="sectors-chips">
                        {sectors.slice(0, 3).map((sector) => (
                            <span class={`sector-chip sector-${getSectorClass(sector)}`}>
                                <span class="sector-icon">{getSectorIcon(sector)}</span>
                                <span class="sector-name">{sector}</span>
                            </span>
                        ))}
                        {sectors.length > 3 && (
                            <span class="sector-chip more-sectors">
                                +{sectors.length - 3} sectores
                            </span>
                        )}
                    </div>
                </div>
            )}

            {/* Fila 3: Acciones en foco */}
            {tickers.length > 0 && (
                <div class="metadata-row">
                    <span class="label-small">ACCIONES EN FOCO</span>
                    <div class="tickers-list">
                        {tickers.map((ticker) => (
                            <span class="ticker-chip stock-link">
                                <span class="ticker-symbol">{ticker}</span>
                                <span class="ticker-trend external-arrow">‚Üó</span>
                            </span>
                        ))}
                    </div>
                </div>
            )}
        </div>

        {/* 4. CUARTO: Bot√≥n secundario */}
        <div class="news-footer">
            <button class="btn-details">Ver detalles ‚Üí</button>
        </div>
        
    </a>
</article>

<style>
    .news-card{
        background: #FFFFFF;
        border: 1px solid #E0E0E0;
        border-radius: 12px;
        padding: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        overflow: hidden;
        margin-top: 1rem;
        margin-bottom: 1rem;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .news-card:hover {
        box-shadow: var(--shadow-md);
        border-color: #BDBDBD;
    }

    /* 1. SECCI√ìN DEL T√çTULO - Lo m√°s prominente */
    .news-title-section {
        padding: 24px 0 16px 0;
        margin-bottom: 8px;
    }

    .news-title {
        font-size: 2rem; /* 32px - Tama√±o grande */
        font-weight: 700; /* Bold fuerte */
        color: #1A1A1A; /* Negro intenso para m√°ximo contraste */
        line-height: 1.2;
        margin: 0;
        letter-spacing: -0.02em; /* Espaciado negativo para t√≠tulos grandes */
        transition: color 0.2s ease;
    }

    .news-title:hover {
        color: #1565C0; /* Azul al hacer hover */
        cursor: pointer;
    }

    .news-title:hover::after {
        content: '';
        display: block;
        width: 60px;
        height: 3px;
        background: #1976D2;
        margin-top: 8px;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from { width: 0; }
        to { width: 60px; }
    }

    /* 2. SEPARADOR VISUAL */
    .title-separator {
        border: none;
        height: 2px;
        background: linear-gradient(
            to right,
            transparent,
            #E0E0E0 20%,
            #E0E0E0 80%,
            transparent
        );
        margin: 0 0 20px 0;
    }

    /* 3. SECCI√ìN DE METADATA - Compacta y discreta */
    .metadata-section {
        opacity: 0.7; /* Opacidad reducida para no competir con el t√≠tulo */
        font-size: 0.85rem;
        margin-bottom: 20px;
    }

    .metadata-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        gap: 1rem;
    }

    .metadata-row:last-child {
        margin-bottom: 0;
    }

    .badges-container {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .impact-badge, .sentiment-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sentiment-badge {
        border-radius: 6px 0 0 6px;
    }

    .relevance-score {
        display: flex;
        align-items: center;
    }

    .score-label {
        font-size: 0.75rem;
        font-weight: 600;
    }

    .label-small {
        font-size: 0.65rem;
        font-weight: 600;
        color: #757575;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: block;
        margin-bottom: 6px;
        min-width: 120px;
    }

    /* Alternativa: T√≠tulo con Fondo de Color (para casos especiales) */
    .news-title-bold {
        font-size: 1.75rem;
        font-weight: 800;
        color: #FFFFFF;
        background: linear-gradient(135deg, #1565C0 0%, #1976D2 100%);
        padding: 16px 20px;
        margin: 16px -16px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
        line-height: 1.3;
        letter-spacing: -0.02em;
    }

    .news-title-bold:hover {
        background: linear-gradient(135deg, #1976D2 0%, #1E88E5 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    }

    .sectors-chips,
    .tickers-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex: 1;
    }

    .sector-chip,
    .ticker-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.04);
        color: #111827;
        font-size: 0.8rem;
        font-weight: 500;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .sector-chip:hover,
    .ticker-chip:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
    }

    /* Estilos espec√≠ficos para sectores */
    .sector-retail {
        background: #E3F2FD;
        color: #1565C0;
        border: 1px solid #90CAF9;
    }

    .sector-manufacturing {
        background: #E8F5E9;
        color: #2E7D32;
        border: 1px solid #81C784;
    }

    .sector-technology {
        background: #F3E5F5;
        color: #6A1B9A;
        border: 1px solid #BA68C8;
    }

    .sector-finance {
        background: #FFF3E0;
        color: #E65100;
        border: 1px solid #FFB74D;
    }

    .sector-energy {
        background: #FFF8E1;
        color: #F57C00;
        border: 1px solid #FFCC02;
    }

    .sector-healthcare {
        background: #FCE4EC;
        color: #C2185B;
        border: 1px solid #F8BBD9;
    }

    .sector-icon {
        font-size: 1rem;
        line-height: 1;
    }

    .sector-name {
        text-transform: capitalize;
    }

    .more-sectors {
        background: rgba(124, 58, 237, 0.12);
        color: #7c3aed;
    }

    .stock-link {
        background: #E8EAF6;
        color: #3F51B5;
        border: 1px solid #C5CAE9;
        transition: all 0.2s ease;
    }

    .stock-link:hover {
        background: #3F51B5;
        color: #FFFFFF;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(63, 81, 181, 0.3);
    }

    .ticker-symbol {
        font-weight: 700;
        letter-spacing: 0.02em;
    }

    .external-arrow {
        color: #5C6BC0;
        font-size: 0.9rem;
    }

    .stock-link:hover .external-arrow {
        color: #FFFFFF;
    }

    /* 4. FOOTER - Bot√≥n secundario discreto */
    .news-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #F0F0F0;
    }

    .btn-details {
        color: #666666;
        background: transparent;
        border: 1px solid #E0E0E0;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-details:hover {
        background: #F5F5F5;
        color: #333333;
        border-color: #CCCCCC;
        transform: translateY(-1px);
    }

    /* Tama√±os Responsivos para el T√≠tulo */
    /* Desktop */
    @media (min-width: 1024px) {
        .news-title {
            font-size: 2.25rem; /* 36px */
        }
    }

    /* Tablet */
    @media (min-width: 768px) and (max-width: 1023px) {
        .news-title {
            font-size: 1.75rem; /* 28px */
        }
    }

    /* Mobile */
    @media (max-width: 767px) {
        .news-title {
            font-size: 1.5rem; /* 24px */
        }
        
        .news-title-section {
            padding: 16px 0 12px 0;
        }
        
        .title-separator {
            margin: 0 0 16px 0;
        }
        
        .metadata-section {
            font-size: 0.8rem;
            margin-bottom: 16px;
        }
        
        .metadata-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .relevance-score {
            align-self: flex-end;
        }
    }

    /* Responsive general */
    @media (max-width: 768px) {
        .news-card {
            padding: 1rem;
        }
        
        .sector-chip,
        .ticker-chip {
            font-size: 0.7rem;
            padding: 0.3rem 0.6rem;
        }
        
        .badges-container {
            gap: 0.4rem;
        }
        
        .impact-badge, .sentiment-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
    }

    /* Animaciones */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
    }

    .news-card {
        animation: fadeInUp 0.5s ease forwards;
    }

    .news-card:nth-child(1) { animation-delay: 0.1s; }
    .news-card:nth-child(2) { animation-delay: 0.2s; }
</style>
